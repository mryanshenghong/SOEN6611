<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Apache JSPWiki Main Jar</a> &gt; <a href="index.source.html" class="el_package">org.apache.wiki.auth</a> &gt; <span class="el_source">UserManager.java</span></div><h1>UserManager.java</h1><pre class="source lang-java linenums">/*
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    &quot;License&quot;); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
 */
package org.apache.wiki.auth;

import java.io.IOException;
import java.security.Permission;
import java.security.Principal;
import java.text.MessageFormat;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Properties;
import java.util.ResourceBundle;
import java.util.WeakHashMap;

import javax.mail.MessagingException;
import javax.mail.internet.AddressException;
import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.apache.commons.lang.StringUtils;
import org.apache.log4j.Logger;
import org.apache.wiki.WikiContext;
import org.apache.wiki.WikiEngine;
import org.apache.wiki.WikiSession;
import org.apache.wiki.ajax.AjaxUtil;
import org.apache.wiki.ajax.WikiAjaxDispatcherServlet;
import org.apache.wiki.ajax.WikiAjaxServlet;
import org.apache.wiki.api.engine.FilterManager;
import org.apache.wiki.api.exceptions.NoRequiredPropertyException;
import org.apache.wiki.api.exceptions.WikiException;
import org.apache.wiki.api.filters.PageFilter;
import org.apache.wiki.auth.permissions.AllPermission;
import org.apache.wiki.auth.permissions.WikiPermission;
import org.apache.wiki.auth.user.AbstractUserDatabase;
import org.apache.wiki.auth.user.DuplicateUserException;
import org.apache.wiki.auth.user.UserDatabase;
import org.apache.wiki.auth.user.UserProfile;
import org.apache.wiki.event.WikiEventListener;
import org.apache.wiki.event.WikiEventManager;
import org.apache.wiki.event.WikiSecurityEvent;
import org.apache.wiki.filters.SpamFilter;
import org.apache.wiki.i18n.InternationalizationManager;
import org.apache.wiki.preferences.Preferences;
import org.apache.wiki.ui.InputValidator;
import org.apache.wiki.util.ClassUtil;
import org.apache.wiki.util.MailUtil;
import org.apache.wiki.workflow.Decision;
import org.apache.wiki.workflow.DecisionRequiredException;
import org.apache.wiki.workflow.Fact;
import org.apache.wiki.workflow.Outcome;
import org.apache.wiki.workflow.Task;
import org.apache.wiki.workflow.Workflow;
import org.apache.wiki.workflow.WorkflowBuilder;


/**
 * Provides a facade for obtaining user information.
 * @since 2.3
 */
public class UserManager {

    private static final String USERDATABASE_PACKAGE = &quot;org.apache.wiki.auth.user&quot;;
    private static final String SESSION_MESSAGES = &quot;profile&quot;;
    private static final String PARAM_EMAIL = &quot;email&quot;;
    private static final String PARAM_FULLNAME = &quot;fullname&quot;;
    private static final String PARAM_PASSWORD = &quot;password&quot;;
    private static final String PARAM_LOGINNAME = &quot;loginname&quot;;
    private static final String UNKNOWN_CLASS = &quot;&lt;unknown&gt;&quot;;

    private WikiEngine m_engine;

<span class="fc" id="L90">    private static Logger log = Logger.getLogger(UserManager.class);</span>

    /** Message key for the &quot;save profile&quot; message. */
    public  static final String SAVE_APPROVER               = &quot;workflow.createUserProfile&quot;;
    private static final String PROP_DATABASE               = &quot;jspwiki.userdatabase&quot;;
    protected static final String SAVE_TASK_MESSAGE_KEY     = &quot;task.createUserProfile&quot;;
    protected static final String SAVED_PROFILE             = &quot;userProfile&quot;;
    protected static final String SAVE_DECISION_MESSAGE_KEY = &quot;decision.createUserProfile&quot;;
    protected static final String FACT_SUBMITTER            = &quot;fact.submitter&quot;;
    protected static final String PREFS_LOGIN_NAME          = &quot;prefs.loginname&quot;;
    protected static final String PREFS_FULL_NAME           = &quot;prefs.fullname&quot;;
    protected static final String PREFS_EMAIL               = &quot;prefs.email&quot;;

    public static final String JSON_USERS = &quot;users&quot;;

    // private static final String  PROP_ACLMANAGER     = &quot;jspwiki.aclManager&quot;;

    /** Associates wiki sessions with profiles */
<span class="fc" id="L108">    private final Map&lt;WikiSession,UserProfile&gt; m_profiles = new WeakHashMap&lt;&gt;();</span>

    /** The user database loads, manages and persists user identities */
    private UserDatabase     m_database;

    /**
     * Constructs a new UserManager instance.
     */
    public UserManager()
<span class="fc" id="L117">    {</span>
<span class="fc" id="L118">    }</span>

    /**
     * Initializes the engine for its nefarious purposes.
     * @param engine the current wiki engine
     * @param props the wiki engine initialization properties
     */
    public void initialize( WikiEngine engine, Properties props )
    {
<span class="fc" id="L127">        m_engine = engine;</span>

        // Attach the PageManager as a listener
        // TODO: it would be better if we did this in PageManager directly
<span class="fc" id="L131">        addWikiEventListener( engine.getPageManager() );</span>

        //TODO: Replace with custom annotations. See JSPWIKI-566
<span class="fc" id="L134">        WikiAjaxDispatcherServlet.registerServlet( JSON_USERS, new JSONUserModule(this), new AllPermission(null));</span>
<span class="fc" id="L135">    }</span>

    /**
     * Returns the UserDatabase employed by this WikiEngine. The UserDatabase is
     * lazily initialized by this method, if it does not exist yet. If the
     * initialization fails, this method will use the inner class
     * DummyUserDatabase as a default (which is enough to get JSPWiki running).
     * @return the dummy user database
     * @since 2.3
     */
    public UserDatabase getUserDatabase()
    {
        // FIXME: Must not throw RuntimeException, but something else.
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if( m_database != null )</span>
        {
<span class="fc" id="L150">            return m_database;</span>
        }

<span class="fc" id="L153">        String dbClassName = UNKNOWN_CLASS;</span>

        try
        {
<span class="fc" id="L157">            dbClassName = m_engine.getRequiredProperty( m_engine.getWikiProperties(), PROP_DATABASE );</span>

<span class="fc" id="L159">            log.info(&quot;Attempting to load user database class &quot;+dbClassName);</span>
<span class="fc" id="L160">            final Class&lt;?&gt; dbClass = ClassUtil.findClass( USERDATABASE_PACKAGE, dbClassName );</span>
<span class="fc" id="L161">            m_database = (UserDatabase) dbClass.newInstance();</span>
<span class="fc" id="L162">            m_database.initialize( m_engine, m_engine.getWikiProperties() );</span>
<span class="fc" id="L163">            log.info(&quot;UserDatabase initialized.&quot;);</span>
        }
<span class="nc" id="L165">        catch( final NoRequiredPropertyException e )</span>
        {
<span class="nc" id="L167">            log.error( &quot;You have not set the '&quot;+PROP_DATABASE+&quot;'. You need to do this if you want to enable user management by JSPWiki.&quot;, e );</span>
        }
<span class="nc" id="L169">        catch( final ClassNotFoundException e )</span>
        {
<span class="nc" id="L171">            log.error( &quot;UserDatabase class &quot; + dbClassName + &quot; cannot be found&quot;, e );</span>
        }
<span class="nc" id="L173">        catch( final InstantiationException e )</span>
        {
<span class="nc" id="L175">            log.error( &quot;UserDatabase class &quot; + dbClassName + &quot; cannot be created&quot;, e );</span>
        }
<span class="nc" id="L177">        catch( final IllegalAccessException e )</span>
        {
<span class="nc" id="L179">            log.error( &quot;You are not allowed to access this user database class&quot;, e );</span>
        }
<span class="nc" id="L181">        catch( final WikiSecurityException e )</span>
        {
<span class="nc" id="L183">            log.error( &quot;Exception initializing user database: &quot; + e.getMessage(), e );</span>
        }
        finally
        {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">            if( m_database == null )</span>
            {
<span class="nc" id="L189">                log.info(&quot;I could not create a database object you specified (or didn't specify), so I am falling back to a default.&quot;);</span>
<span class="nc" id="L190">                m_database = new DummyUserDatabase();</span>
            }
        }

<span class="fc" id="L194">        return m_database;</span>
    }

    /**
     * &lt;p&gt;Retrieves the {@link org.apache.wiki.auth.user.UserProfile}for the
     * user in a wiki session. If the user is authenticated, the UserProfile
     * returned will be the one stored in the user database; if one does not
     * exist, a new one will be initialized and returned. If the user is
     * anonymous or asserted, the UserProfile will &lt;i&gt;always&lt;/i&gt; be newly
     * initialized to prevent spoofing of identities. If a UserProfile needs to
     * be initialized, its
     * {@link org.apache.wiki.auth.user.UserProfile#isNew()} method will
     * return &lt;code&gt;true&lt;/code&gt;, and its login name will will be set
     * automatically if the user is authenticated. Note that this method does
     * not modify the retrieved (or newly created) profile otherwise; other
     * fields in the user profile may be &lt;code&gt;null&lt;/code&gt;.&lt;/p&gt;
     * &lt;p&gt;If a new UserProfile was created, but its
     * {@link org.apache.wiki.auth.user.UserProfile#isNew()} method returns
     * &lt;code&gt;false&lt;/code&gt;, this method throws an {@link IllegalStateException}.
     * This is meant as a quality check for UserDatabase providers;
     * it should only be thrown if the implementation is faulty.&lt;/p&gt;
     * @param session the wiki session, which may not be &lt;code&gt;null&lt;/code&gt;
     * @return the user's profile, which will be newly initialized if the user
     * is anonymous or asserted, or if the user cannot be found in the user
     * database
     */
    public UserProfile getUserProfile( WikiSession session )
    {
        // Look up cached user profile
<span class="fc" id="L223">        UserProfile profile = m_profiles.get( session );</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">        boolean newProfile = profile == null;</span>
<span class="fc" id="L225">        Principal user = null;</span>

        // If user is authenticated, figure out if this is an existing profile
<span class="fc bfc" id="L228" title="All 2 branches covered.">        if ( session.isAuthenticated() )</span>
        {
<span class="fc" id="L230">            user = session.getUserPrincipal();</span>
            try
            {
<span class="fc" id="L233">                profile = getUserDatabase().find( user.getName() );</span>
<span class="fc" id="L234">                newProfile = false;</span>
            }
<span class="nc" id="L236">            catch( final NoSuchPrincipalException e )</span>
            {
<span class="fc" id="L238">            }</span>
        }

<span class="fc bfc" id="L241" title="All 2 branches covered.">        if ( newProfile )</span>
        {
<span class="fc" id="L243">            profile = getUserDatabase().newProfile();</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if ( user != null )</span>
            {
<span class="nc" id="L246">                profile.setLoginName( user.getName() );</span>
            }
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">            if ( !profile.isNew() )</span>
            {
<span class="nc" id="L250">                throw new IllegalStateException(</span>
                        &quot;New profile should be marked 'new'. Check your UserProfile implementation.&quot; );
            }
        }

        // Stash the profile for next time
<span class="fc" id="L256">        m_profiles.put( session, profile );</span>
<span class="fc" id="L257">        return profile;</span>
    }

    /**
     * &lt;p&gt;
     * Saves the {@link org.apache.wiki.auth.user.UserProfile}for the user in
     * a wiki session. This method verifies that a user profile to be saved
     * doesn't collide with existing profiles; that is, the login name
     * or full name is already used by another profile. If the profile
     * collides, a &lt;code&gt;DuplicateUserException&lt;/code&gt; is thrown. After saving
     * the profile, the user database changes are committed, and the user's
     * credential set is refreshed; if custom authentication is used, this means
     * the user will be automatically be logged in.
     * &lt;/p&gt;
     * &lt;p&gt;
     * When the user's profile is saved successfully, this method fires a
     * {@link WikiSecurityEvent#PROFILE_SAVE} event with the WikiSession as the
     * source and the UserProfile as target. For existing profiles, if the
     * user's full name changes, this method also fires a &quot;name changed&quot;
     * event ({@link WikiSecurityEvent#PROFILE_NAME_CHANGED}) with the
     * WikiSession as the source and an array containing the old and new
     * UserProfiles, respectively. The &lt;code&gt;NAME_CHANGED&lt;/code&gt; event allows
     * the GroupManager and PageManager can change group memberships and
     * ACLs if needed.
     * &lt;/p&gt;
     * &lt;p&gt;
     * Note that WikiSessions normally attach event listeners to the
     * UserManager, so changes to the profile will automatically cause the
     * correct Principals to be reloaded into the current WikiSession's Subject.
     * &lt;/p&gt;
     * @param session the wiki session, which may not be &lt;code&gt;null&lt;/code&gt;
     * @param profile the user profile, which may not be &lt;code&gt;null&lt;/code&gt;
     * @throws DuplicateUserException if the proposed profile's login name or full name collides with another
     * @throws WikiException if the save fails for some reason. If the current user does not have
     * permission to save the profile, this will be a {@link org.apache.wiki.auth.WikiSecurityException};
     * if if the user profile must be approved before it can be saved, it will be a
     * {@link org.apache.wiki.workflow.DecisionRequiredException}. All other WikiException
     * indicate a condition that is not normal is probably due to mis-configuration
     */
    public void setUserProfile( WikiSession session, UserProfile profile ) throws DuplicateUserException, WikiException
    {
        // Verify user is allowed to save profile!
<span class="fc" id="L299">        final Permission p = new WikiPermission( m_engine.getApplicationName(), WikiPermission.EDIT_PROFILE_ACTION );</span>
<span class="pc bpc" id="L300" title="1 of 2 branches missed.">        if ( !m_engine.getAuthorizationManager().checkPermission( session, p ) )</span>
        {
<span class="nc" id="L302">            throw new WikiSecurityException( &quot;You are not allowed to save wiki profiles.&quot; );</span>
        }

        // Check if profile is new, and see if container allows creation
<span class="fc" id="L306">        final boolean newProfile = profile.isNew();</span>

        // Check if another user profile already has the fullname or loginname
<span class="fc" id="L309">        final UserProfile oldProfile = getUserProfile( session );</span>
<span class="pc bpc" id="L310" title="1 of 4 branches missed.">        final boolean nameChanged = ( oldProfile == null  || oldProfile.getFullname() == null )</span>
            ? false
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">            : !( oldProfile.getFullname().equals( profile.getFullname() ) &amp;&amp;</span>
<span class="pc bnc" id="L313" title="All 2 branches missed.">                 oldProfile.getLoginName().equals( profile.getLoginName() ) );</span>
        UserProfile otherProfile;
        try
        {
<span class="fc" id="L317">            otherProfile = getUserDatabase().findByLoginName( profile.getLoginName() );</span>
<span class="pc bpc" id="L318" title="1 of 4 branches missed.">            if ( otherProfile != null &amp;&amp; !otherProfile.equals( oldProfile ) )</span>
            {
<span class="fc" id="L320">                throw new DuplicateUserException( &quot;security.error.login.taken&quot;, profile.getLoginName() );</span>
            }
        }
<span class="fc" id="L323">        catch( final NoSuchPrincipalException e )</span>
        {
<span class="fc" id="L325">        }</span>
        try
        {
<span class="fc" id="L328">            otherProfile = getUserDatabase().findByFullName( profile.getFullname() );</span>
<span class="pc bpc" id="L329" title="2 of 4 branches missed.">            if ( otherProfile != null &amp;&amp; !otherProfile.equals( oldProfile ) )</span>
            {
<span class="fc" id="L331">                throw new DuplicateUserException( &quot;security.error.fullname.taken&quot;, profile.getFullname() );</span>
            }
        }
<span class="fc" id="L334">        catch( final NoSuchPrincipalException e )</span>
        {
<span class="nc" id="L336">        }</span>

        // For new accounts, create approval workflow for user profile save.
<span class="pc bpc" id="L339" title="2 of 6 branches missed.">        if ( newProfile &amp;&amp; oldProfile != null &amp;&amp; oldProfile.isNew() )</span>
        {
<span class="fc" id="L341">            final WorkflowBuilder builder = WorkflowBuilder.getBuilder( m_engine );</span>
<span class="fc" id="L342">            final Principal submitter = session.getUserPrincipal();</span>
<span class="fc" id="L343">            final Task completionTask = new SaveUserProfileTask( m_engine, session.getLocale() );</span>

            // Add user profile attribute as Facts for the approver (if required)
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">            final boolean hasEmail = profile.getEmail() != null;</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">            final Fact[] facts = new Fact[ hasEmail ? 4 : 3];</span>
<span class="fc" id="L348">            facts[0] = new Fact( PREFS_FULL_NAME, profile.getFullname() );</span>
<span class="fc" id="L349">            facts[1] = new Fact( PREFS_LOGIN_NAME, profile.getLoginName() );</span>
<span class="fc" id="L350">            facts[2] = new Fact( FACT_SUBMITTER, submitter.getName() );</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">            if ( hasEmail )</span>
            {
<span class="fc" id="L353">                facts[3] = new Fact( PREFS_EMAIL, profile.getEmail() );</span>
            }
<span class="fc" id="L355">            final Workflow workflow = builder.buildApprovalWorkflow( submitter,</span>
                                                               SAVE_APPROVER,
                                                               null,
                                                               SAVE_DECISION_MESSAGE_KEY,
                                                               facts,
                                                               completionTask,
                                                               null );

<span class="fc" id="L363">            workflow.setAttribute( SAVED_PROFILE, profile );</span>
<span class="fc" id="L364">            m_engine.getWorkflowManager().start(workflow);</span>

<span class="fc" id="L366">            final boolean approvalRequired = workflow.getCurrentStep() instanceof Decision;</span>

            // If the profile requires approval, redirect user to message page
<span class="fc bfc" id="L369" title="All 2 branches covered.">            if ( approvalRequired )</span>
            {
<span class="fc" id="L371">                throw new DecisionRequiredException( &quot;This profile must be approved before it becomes active&quot; );</span>
            }

            // If the profile doesn't need approval, then just log the user in

            try
            {
<span class="fc" id="L378">                final AuthenticationManager mgr = m_engine.getAuthenticationManager();</span>
<span class="pc bpc" id="L379" title="2 of 4 branches missed.">                if ( newProfile &amp;&amp; !mgr.isContainerAuthenticated() )</span>
                {
<span class="fc" id="L381">                    mgr.login( session, null, profile.getLoginName(), profile.getPassword() );</span>
                }
            }
<span class="nc" id="L384">            catch ( final WikiException e )</span>
            {
<span class="nc" id="L386">                throw new WikiSecurityException( e.getMessage(), e );</span>
<span class="fc" id="L387">            }</span>

            // Alert all listeners that the profile changed...
            // ...this will cause credentials to be reloaded in the wiki session
<span class="fc" id="L391">            fireEvent( WikiSecurityEvent.PROFILE_SAVE, session, profile );</span>
<span class="fc" id="L392">        }</span>

        // For existing accounts, just save the profile
        else
        {
            // If login name changed, rename it first
<span class="pc bpc" id="L398" title="2 of 6 branches missed.">            if ( nameChanged &amp;&amp; oldProfile != null &amp;&amp; !oldProfile.getLoginName().equals( profile.getLoginName() ) )</span>
            {
<span class="fc" id="L400">                getUserDatabase().rename( oldProfile.getLoginName(), profile.getLoginName() );</span>
            }

            // Now, save the profile (userdatabase will take care of timestamps for us)
<span class="fc" id="L404">            getUserDatabase().save( profile );</span>

<span class="pc bpc" id="L406" title="1 of 2 branches missed.">            if ( nameChanged )</span>
            {
                // Fire an event if the login name or full name changed
<span class="fc" id="L409">                final UserProfile[] profiles = new UserProfile[] { oldProfile, profile };</span>
<span class="fc" id="L410">                fireEvent( WikiSecurityEvent.PROFILE_NAME_CHANGED, session, profiles );</span>
<span class="fc" id="L411">            }</span>
            else
            {
                // Fire an event that says we have new a new profile (new principals)
<span class="nc" id="L415">                fireEvent( WikiSecurityEvent.PROFILE_SAVE, session, profile );</span>
            }
        }
<span class="fc" id="L418">    }</span>

    /**
     * &lt;p&gt; Extracts user profile parameters from the HTTP request and populates
     * a UserProfile with them. The UserProfile will either be a copy of the
     * user's existing profile (if one can be found), or a new profile (if not).
     * The rules for populating the profile as as follows: &lt;/p&gt; &lt;ul&gt; &lt;li&gt;If the
     * &lt;code&gt;email&lt;/code&gt; or &lt;code&gt;password&lt;/code&gt; parameter values differ
     * from those in the existing profile, the passed parameters override the
     * old values.&lt;/li&gt; &lt;li&gt;For new profiles, the user-supplied
     * &lt;code&gt;fullname&lt;/code&gt; parameter is always
     * used; for existing profiles the existing value is used, and whatever
     * value the user supplied is discarded. The wiki name is automatically
     * computed by taking the full name and extracting all whitespace.&lt;/li&gt;
     * &lt;li&gt;In all cases, the
     * created/last modified timestamps of the user's existing or new profile
     * always override whatever values the user supplied.&lt;/li&gt; &lt;li&gt;If
     * container authentication is used, the login name property of the profile
     * is set to the name of
     * {@link org.apache.wiki.WikiSession#getLoginPrincipal()}. Otherwise,
     * the value of the &lt;code&gt;loginname&lt;/code&gt; parameter is used.&lt;/li&gt; &lt;/ul&gt;
     * @param context the current wiki context
     * @return a new, populated user profile
     */
    public UserProfile parseProfile( WikiContext context )
    {
        // Retrieve the user's profile (may have been previously cached)
<span class="nc" id="L445">        final UserProfile profile = getUserProfile( context.getWikiSession() );</span>
<span class="nc" id="L446">        final HttpServletRequest request = context.getHttpRequest();</span>

        // Extract values from request stream (cleanse whitespace as needed)
<span class="nc" id="L449">        String loginName = request.getParameter( PARAM_LOGINNAME );</span>
<span class="nc" id="L450">        String password = request.getParameter( PARAM_PASSWORD );</span>
<span class="nc" id="L451">        String fullname = request.getParameter( PARAM_FULLNAME );</span>
<span class="nc" id="L452">        String email = request.getParameter( PARAM_EMAIL );</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        loginName = InputValidator.isBlank( loginName ) ? null : loginName;</span>
<span class="nc bnc" id="L454" title="All 2 branches missed.">        password = InputValidator.isBlank( password ) ? null : password;</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        fullname = InputValidator.isBlank( fullname ) ? null : fullname;</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">        email = InputValidator.isBlank( email ) ? null : email;</span>

        // A special case if we have container authentication
        // If authenticated, login name is always taken from container
<span class="nc bnc" id="L460" title="All 2 branches missed.">        if ( m_engine.getAuthenticationManager().isContainerAuthenticated() &amp;&amp;</span>
<span class="nc bnc" id="L461" title="All 2 branches missed.">                context.getWikiSession().isAuthenticated() )</span>
        {
<span class="nc" id="L463">            loginName = context.getWikiSession().getLoginPrincipal().getName();</span>
        }

        // Set the profile fields!
<span class="nc" id="L467">        profile.setLoginName( loginName );</span>
<span class="nc" id="L468">        profile.setEmail( email );</span>
<span class="nc" id="L469">        profile.setFullname( fullname );</span>
<span class="nc" id="L470">        profile.setPassword( password );</span>
<span class="nc" id="L471">        return profile;</span>
    }

    /**
     * Validates a user profile, and appends any errors to the session errors
     * list. If the profile is new, the password will be checked to make sure it
     * isn't null. Otherwise, the password is checked for length and that it
     * matches the value of the 'password2' HTTP parameter. Note that we have a
     * special case when container-managed authentication is used and the user
     * is not authenticated; this will always cause validation to fail. Any
     * validation errors are added to the wiki session's messages collection
     * (see {@link WikiSession#getMessages()}.
     * @param context the current wiki context
     * @param profile the supplied UserProfile
     */
    public void validateProfile( WikiContext context, UserProfile profile )
    {
<span class="nc" id="L488">        final boolean isNew = profile.isNew();</span>
<span class="nc" id="L489">        final WikiSession session = context.getWikiSession();</span>
<span class="nc" id="L490">        final InputValidator validator = new InputValidator( SESSION_MESSAGES, context );</span>
<span class="nc" id="L491">        final ResourceBundle rb = Preferences.getBundle( context, InternationalizationManager.CORE_BUNDLE );</span>

        //
        //  Query the SpamFilter first
        //
<span class="nc" id="L496">        final FilterManager fm = m_engine.getFilterManager();</span>
<span class="nc" id="L497">        final List&lt;PageFilter&gt; ls = fm.getFilterList();</span>
<span class="nc bnc" id="L498" title="All 2 branches missed.">        for( final PageFilter pf : ls )</span>
        {
<span class="nc bnc" id="L500" title="All 2 branches missed.">            if( pf instanceof SpamFilter )</span>
            {
<span class="nc bnc" id="L502" title="All 2 branches missed.">                if( ((SpamFilter)pf).isValidUserProfile( context, profile ) == false )</span>
                {
<span class="nc" id="L504">                    session.addMessage( SESSION_MESSAGES, &quot;Invalid userprofile&quot; );</span>
<span class="nc" id="L505">                    return;</span>
                }
                break;
            }
<span class="nc" id="L509">        }</span>

        // If container-managed auth and user not logged in, throw an error
<span class="nc bnc" id="L512" title="All 2 branches missed.">        if ( m_engine.getAuthenticationManager().isContainerAuthenticated()</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">             &amp;&amp; !context.getWikiSession().isAuthenticated() )</span>
        {
<span class="nc" id="L515">            session.addMessage( SESSION_MESSAGES, rb.getString(&quot;security.error.createprofilebeforelogin&quot;) );</span>
        }

<span class="nc" id="L518">        validator.validateNotNull( profile.getLoginName(), rb.getString(&quot;security.user.loginname&quot;) );</span>
<span class="nc" id="L519">        validator.validateNotNull( profile.getFullname(), rb.getString(&quot;security.user.fullname&quot;) );</span>
<span class="nc" id="L520">        validator.validate( profile.getEmail(), rb.getString(&quot;security.user.email&quot;), InputValidator.EMAIL );</span>

        // If new profile, passwords must match and can't be null
<span class="nc bnc" id="L523" title="All 2 branches missed.">        if ( !m_engine.getAuthenticationManager().isContainerAuthenticated() )</span>
        {
<span class="nc" id="L525">            final String password = profile.getPassword();</span>
<span class="nc bnc" id="L526" title="All 2 branches missed.">            if ( password == null )</span>
            {
<span class="nc bnc" id="L528" title="All 2 branches missed.">                if ( isNew )</span>
                {
<span class="nc" id="L530">                    session.addMessage( SESSION_MESSAGES, rb.getString(&quot;security.error.blankpassword&quot;) );</span>
                }
            }
            else
            {
<span class="nc" id="L535">                final HttpServletRequest request = context.getHttpRequest();</span>
<span class="nc bnc" id="L536" title="All 2 branches missed.">                final String password2 = ( request == null ) ? null : request.getParameter( &quot;password2&quot; );</span>
<span class="nc bnc" id="L537" title="All 2 branches missed.">                if ( !password.equals( password2 ) )</span>
                {
<span class="nc" id="L539">                    session.addMessage( SESSION_MESSAGES, rb.getString(&quot;security.error.passwordnomatch&quot;) );</span>
                }
            }
        }

        UserProfile otherProfile;
<span class="nc" id="L545">        final String fullName = profile.getFullname();</span>
<span class="nc" id="L546">        final String loginName = profile.getLoginName();</span>
<span class="nc" id="L547">        final String email = profile.getEmail();</span>

        // It's illegal to use as a full name someone else's login name
        try
        {
<span class="nc" id="L552">            otherProfile = getUserDatabase().find( fullName );</span>
<span class="nc bnc" id="L553" title="All 6 branches missed.">            if ( otherProfile != null &amp;&amp; !profile.equals( otherProfile ) &amp;&amp; !fullName.equals( otherProfile.getFullname() ) )</span>
            {
<span class="nc" id="L555">                final Object[] args = { fullName };</span>
<span class="nc" id="L556">                session.addMessage( SESSION_MESSAGES, MessageFormat.format( rb.getString(&quot;security.error.illegalfullname&quot;), args ) );</span>
            }
        }
<span class="nc" id="L559">        catch ( final NoSuchPrincipalException e)</span>
<span class="nc" id="L560">        { /* It's clean */ }</span>

        // It's illegal to use as a login name someone else's full name
        try
        {
<span class="nc" id="L565">            otherProfile = getUserDatabase().find( loginName );</span>
<span class="nc bnc" id="L566" title="All 6 branches missed.">            if ( otherProfile != null &amp;&amp; !profile.equals( otherProfile ) &amp;&amp; !loginName.equals( otherProfile.getLoginName() ) )</span>
            {
<span class="nc" id="L568">                final Object[] args = { loginName };</span>
<span class="nc" id="L569">                session.addMessage( SESSION_MESSAGES, MessageFormat.format( rb.getString(&quot;security.error.illegalloginname&quot;), args ) );</span>
            }
        }
<span class="nc" id="L572">        catch ( final NoSuchPrincipalException e)</span>
<span class="nc" id="L573">        { /* It's clean */ }</span>

        // It's illegal to use multiple accounts with the same email
        try
        {
<span class="nc" id="L578">            otherProfile = getUserDatabase().findByEmail( email );</span>
<span class="nc bnc" id="L579" title="All 2 branches missed.">            if ( otherProfile != null</span>
<span class="nc bnc" id="L580" title="All 2 branches missed.">                &amp;&amp; !profile.getUid().equals(otherProfile.getUid()) // Issue JSPWIKI-1042</span>
<span class="nc bnc" id="L581" title="All 4 branches missed.">                &amp;&amp; !profile.equals( otherProfile ) &amp;&amp; StringUtils.lowerCase( email ).equals( StringUtils.lowerCase(otherProfile.getEmail() ) ) )</span>
            {
<span class="nc" id="L583">                final Object[] args = { email };</span>
<span class="nc" id="L584">                session.addMessage( SESSION_MESSAGES, MessageFormat.format( rb.getString(&quot;security.error.email.taken&quot;), args ) );</span>
            }
        }
<span class="nc" id="L587">        catch ( final NoSuchPrincipalException e)</span>
<span class="nc" id="L588">        { /* It's clean */ }</span>
<span class="nc" id="L589">    }</span>

    /**
     *  A helper method for returning all of the known WikiNames in this system.
     *
     *  @return An Array of Principals
     *  @throws WikiSecurityException If for reason the names cannot be fetched
     */
    public Principal[] listWikiNames()
        throws WikiSecurityException
    {
<span class="nc" id="L600">        return getUserDatabase().getWikiNames();</span>
    }

    /**
     * This is a database that gets used if nothing else is available. It does
     * nothing of note - it just mostly throws NoSuchPrincipalExceptions if
     * someone tries to log in.
     */
<span class="nc" id="L608">    public static class DummyUserDatabase extends AbstractUserDatabase</span>
    {

        /**
         * No-op.
         * @throws WikiSecurityException never...
         */
        @Override
        public void commit() throws WikiSecurityException
        {
            // No operation
<span class="nc" id="L619">        }</span>

        /**
         * No-op.
         * @param loginName the login name to delete
         * @throws WikiSecurityException never...
         */
        @Override
        public void deleteByLoginName( String loginName ) throws WikiSecurityException
        {
            // No operation
<span class="nc" id="L630">        }</span>

        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param index the name to search for
         * @return the user profile
         * @throws NoSuchPrincipalException never...
         */
        @Override
        public UserProfile findByEmail(String index) throws NoSuchPrincipalException
        {
<span class="nc" id="L641">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }

        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param index the name to search for
         * @return the user profile
         * @throws NoSuchPrincipalException never...
         */
        @Override
        public UserProfile findByFullName(String index) throws NoSuchPrincipalException
        {
<span class="nc" id="L653">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }

        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param index the name to search for
         * @return the user profile
         * @throws NoSuchPrincipalException never...
         */
        @Override
        public UserProfile findByLoginName(String index) throws NoSuchPrincipalException
        {
<span class="nc" id="L665">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }

        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param uid the unique identifier to search for
         * @return the user profile
         * @throws NoSuchPrincipalException never...
         */
        @Override
        public UserProfile findByUid( String uid ) throws NoSuchPrincipalException
        {
<span class="nc" id="L677">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }
        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param index the name to search for
         * @return the user profile
         * @throws NoSuchPrincipalException never...
         */
        @Override
        public UserProfile findByWikiName(String index) throws NoSuchPrincipalException
        {
<span class="nc" id="L688">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }

        /**
         * No-op.
         * @return a zero-length array
         * @throws WikiSecurityException never...
         */
        @Override
        public Principal[] getWikiNames() throws WikiSecurityException
        {
<span class="nc" id="L699">            return new Principal[0];</span>
        }

        /**
         * No-op.
         *
         * @param engine the wiki engine
         * @param props the properties used to initialize the wiki engine
         * @throws NoRequiredPropertyException never...
         */
        @Override
        public void initialize(WikiEngine engine, Properties props) throws NoRequiredPropertyException
        {
<span class="nc" id="L712">        }</span>

        /**
         * No-op; always throws &lt;code&gt;NoSuchPrincipalException&lt;/code&gt;.
         * @param loginName the login name
         * @param newName the proposed new login name
         * @throws DuplicateUserException never...
         * @throws WikiSecurityException never...
         */
        @Override
        public void rename( String loginName, String newName ) throws DuplicateUserException, WikiSecurityException
        {
<span class="nc" id="L724">            throw new NoSuchPrincipalException(&quot;No user profiles available&quot;);</span>
        }

        /**
         * No-op.
         * @param profile the user profile
         * @throws WikiSecurityException never...
         */
        @Override
        public void save( UserProfile profile ) throws WikiSecurityException
        {
<span class="nc" id="L735">        }</span>

    }

    // workflow task inner classes....................................................

    /**
     * Inner class that handles the actual profile save action. Instances
     * of this class are assumed to have been added to an approval workflow via
     * {@link org.apache.wiki.workflow.WorkflowBuilder#buildApprovalWorkflow(Principal, String, Task, String, org.apache.wiki.workflow.Fact[], Task, String)};
     * they will not function correctly otherwise.
     *
     */
    public static class SaveUserProfileTask extends Task
    {
        private static final long serialVersionUID = 6994297086560480285L;
        private final UserDatabase m_db;
        private final WikiEngine m_engine;
        private final Locale m_loc;

        /**
         * Constructs a new Task for saving a user profile.
         * @param engine the wiki engine
         * @deprecated will be removed in 2.10 scope. Consider using
         * {@link #UserManager.SaveUserProfileTask(WikiEngine, Locale)} instead
         */
        @Deprecated
        public SaveUserProfileTask( WikiEngine engine )
        {
<span class="nc" id="L764">            super( SAVE_TASK_MESSAGE_KEY );</span>
<span class="nc" id="L765">            m_engine = engine;</span>
<span class="nc" id="L766">            m_db = engine.getUserManager().getUserDatabase();</span>
<span class="nc" id="L767">            m_loc = null;</span>
<span class="nc" id="L768">        }</span>

        public SaveUserProfileTask( WikiEngine engine, Locale loc )
        {
<span class="fc" id="L772">            super( SAVE_TASK_MESSAGE_KEY );</span>
<span class="fc" id="L773">            m_engine = engine;</span>
<span class="fc" id="L774">            m_db = engine.getUserManager().getUserDatabase();</span>
<span class="fc" id="L775">            m_loc = loc;</span>
<span class="fc" id="L776">        }</span>

        /**
         * Saves the user profile to the user database.
         * @return {@link org.apache.wiki.workflow.Outcome#STEP_COMPLETE} if the
         * task completed successfully
         * @throws WikiException if the save did not complete for some reason
         */
        @Override
        public Outcome execute() throws WikiException
        {
            // Retrieve user profile
<span class="fc" id="L788">            final UserProfile profile = (UserProfile) getWorkflow().getAttribute( SAVED_PROFILE );</span>

            // Save the profile (userdatabase will take care of timestamps for us)
<span class="fc" id="L791">            m_db.save( profile );</span>

            // Send e-mail if user supplied an e-mail address
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">            if ( profile.getEmail() != null )</span>
            {
                try
                {
<span class="fc" id="L798">                    final InternationalizationManager i18n = m_engine.getInternationalizationManager();</span>
<span class="fc" id="L799">                    final String app = m_engine.getApplicationName();</span>
<span class="fc" id="L800">                    final String to = profile.getEmail();</span>
<span class="fc" id="L801">                    final String subject = i18n.get( InternationalizationManager.DEF_TEMPLATE, m_loc,</span>
                                               &quot;notification.createUserProfile.accept.subject&quot;, app );

<span class="fc" id="L804">                    final String content = i18n.get( InternationalizationManager.DEF_TEMPLATE, m_loc,</span>
                                               &quot;notification.createUserProfile.accept.content&quot;, app,
<span class="fc" id="L806">                                               profile.getLoginName(),</span>
<span class="fc" id="L807">                                               profile.getFullname(),</span>
<span class="fc" id="L808">                                               profile.getEmail(),</span>
<span class="fc" id="L809">                                               m_engine.getURL( WikiContext.LOGIN, null, null, true ) );</span>
<span class="nc" id="L810">                    MailUtil.sendMessage( m_engine.getWikiProperties(), to, subject, content);</span>
                }
<span class="nc" id="L812">                catch ( final AddressException e)</span>
                {
                }
<span class="fc" id="L815">                catch ( final MessagingException me )</span>
                {
<span class="fc" id="L817">                    log.error( &quot;Could not send registration confirmation e-mail. Is the e-mail server running?&quot;, me );</span>
<span class="nc" id="L818">                }</span>
            }

<span class="fc" id="L821">            return Outcome.STEP_COMPLETE;</span>
        }
    }

    // events processing .......................................................

    /**
     * Registers a WikiEventListener with this instance.
     * This is a convenience method.
     * @param listener the event listener
     */
    public synchronized void addWikiEventListener( WikiEventListener listener )
    {
<span class="fc" id="L834">        WikiEventManager.addWikiEventListener( this, listener );</span>
<span class="fc" id="L835">    }</span>

    /**
     * Un-registers a WikiEventListener with this instance.
     * This is a convenience method.
     * @param listener the event listener
     */
    public synchronized void removeWikiEventListener( WikiEventListener listener )
    {
<span class="nc" id="L844">        WikiEventManager.removeWikiEventListener( this, listener );</span>
<span class="nc" id="L845">    }</span>

    /**
     *  Fires a WikiSecurityEvent of the provided type, Principal and target Object
     *  to all registered listeners.
     *
     * @see org.apache.wiki.event.WikiSecurityEvent
     * @param type       the event type to be fired
     * @param session    the wiki session supporting the event
     * @param profile    the user profile (or array of user profiles), which may be &lt;code&gt;null&lt;/code&gt;
     */
    protected void fireEvent( int type, WikiSession session, Object profile )
    {
<span class="pc bpc" id="L858" title="1 of 2 branches missed.">        if ( WikiEventManager.isListening(this) )</span>
        {
<span class="fc" id="L860">            WikiEventManager.fireEvent(this,new WikiSecurityEvent(session,type,profile));</span>
        }
<span class="fc" id="L862">    }</span>

    /**
     *  Implements the JSON API for usermanager.
     *  &lt;p&gt;
     *  Even though this gets serialized whenever container shuts down/restarts,
     *  this gets reinstalled to the session when JSPWiki starts.  This means
     *  that it's not actually necessary to save anything.
     */
    public static final class JSONUserModule implements WikiAjaxServlet
    {
		private volatile UserManager m_manager;

        /**
         *  Create a new JSONUserModule.
         *  @param mgr Manager
         */
        public JSONUserModule( UserManager mgr )
<span class="fc" id="L880">        {</span>
<span class="fc" id="L881">            m_manager = mgr;</span>
<span class="fc" id="L882">        }</span>

        @Override
        public String getServletMapping() {
<span class="nc" id="L886">        	return JSON_USERS;</span>
        }

        @Override
        public void service(HttpServletRequest req, HttpServletResponse resp, String actionName, List&lt;String&gt; params) throws ServletException, IOException {
        	try {
<span class="nc" id="L892">        		String uid = null;</span>
<span class="nc bnc" id="L893" title="All 2 branches missed.">            	if (params.size()&lt;1) {</span>
<span class="nc" id="L894">            		return;</span>
            	}
<span class="nc" id="L896">        		uid = params.get(0);</span>
<span class="nc" id="L897">	        	log.debug(&quot;uid=&quot;+uid);</span>
<span class="nc bnc" id="L898" title="All 2 branches missed.">	        	if (StringUtils.isNotBlank(uid)) {</span>
<span class="nc" id="L899">		            final UserProfile prof = getUserInfo(uid);</span>
<span class="nc" id="L900">		            resp.getWriter().write(AjaxUtil.toJson(prof));</span>
	        	}
<span class="nc" id="L902">        	} catch (final NoSuchPrincipalException e) {</span>
<span class="nc" id="L903">        		throw new ServletException(e);</span>
<span class="nc" id="L904">        	}</span>
<span class="nc" id="L905">        }</span>

        /**
         *  Directly returns the UserProfile object attached to an uid.
         *
         *  @param uid The user id (e.g. WikiName)
         *  @return A UserProfile object
         *  @throws NoSuchPrincipalException If such a name does not exist.
         */
        public UserProfile getUserInfo( String uid )
            throws NoSuchPrincipalException
        {
<span class="nc bnc" id="L917" title="All 2 branches missed.">            if( m_manager != null )</span>
            {
<span class="nc" id="L919">                final UserProfile prof = m_manager.getUserDatabase().find( uid );</span>

<span class="nc" id="L921">                return prof;</span>
            }

<span class="nc" id="L924">            throw new IllegalStateException(&quot;The manager is offline.&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>